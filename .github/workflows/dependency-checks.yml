name: Dependency Health Check

on:
  schedule:
    - cron: '0 9 * * 1' # Weekly Monday 9 AM
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

jobs:
  dependency-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      # 1. Security Audit
      - name: Security Vulnerability Scan
        run: |
          echo "ðŸ” Scanning root dependencies..."
          npm audit --json > audit-root.json || true

          # Check for critical/high vulnerabilities
          CRITICAL=$(cat audit-root.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat audit-root.json | jq '.metadata.vulnerabilities.high // 0')

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical and $HIGH high vulnerabilities"
            echo ""
            echo "# Critical and High Severity Vulnerabilities Only"
            echo ""
            
            # Filter and display only critical and high vulnerabilities
            cat audit-root.json | jq -r '
              .vulnerabilities | 
              to_entries[] | 
              select(.value.severity == "critical" or .value.severity == "high") |
              "## \(.key)\n**Severity:** \(.value.severity)\n**Via:** \(.value.via | map(if type == "string" then . else .title end) | join(", "))\n**Range:** \(.value.range)\n**Fix Available:** \(.value.fixAvailable // false)\n"
            '
            
            exit 1
          else
            echo "âœ… No critical or high vulnerabilities found"
          fi

      # 3. Auto-test Dependabot PRs
      - name: Test Dependency Updates
        if: github.actor == 'dependabot[bot]'
        run: |
          npm ci
          npm run lint
          npm test -- --maxWorkers=2
          npm run build

      # 4. License Compliance (only when deps change)
      - name: License Compliance Check
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ“„ Checking licenses..."
          npx license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;CC0-1.0;Unlicense" --summary

      # 5. Lockfile Validation
      - name: Validate Lockfiles
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ”’ Validating root lockfile..."
          npm ci --dry-run
          git diff --exit-code package-lock.json || {
            echo "::error::package-lock.json is out of sync"
            exit 1
          }

      # Create issue for security vulnerabilities
      - name: Create Security Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Security Vulnerabilities Detected',
              labels: ['security', 'dependencies', 'priority-high'],
              body: `## Security Scan Failed
              
              Critical or high severity vulnerabilities detected in dependencies.
              
              **Action Required:** Review and patch immediately.
              
              Run locally to see only critical/high:
              \`\`\`bash
              npm audit --json | jq '.vulnerabilities | to_entries[] | select(.value.severity == "critical" or .value.severity == "high")'
              \`\`\`
              
              [View CI Run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });
