name: Dependency Health Check

on:
  schedule:
    - cron: '0 9 * * 1'
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

jobs:
  dependency-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Security Vulnerability Scan
        id: audit
        continue-on-error: true
        run: |
          echo "Scanning dependencies for security vulnerabilities..."
          npm audit --audit-level=high --json > audit-report.json

          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-report.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-report.json)

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT

          echo ""
          echo "SECURITY AUDIT SUMMARY"
          echo ""
          echo "Critical: $CRITICAL"
          echo "High:     $HIGH"
          echo "Moderate: $MODERATE"
          echo ""

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "CRITICAL or HIGH vulnerabilities detected. Please review."
            npm audit --audit-level=high
            exit 1
          fi

      - name: Test Dependency Updates
        if: github.actor == 'dependabot[bot]'
        run: |
          npm ci
          npm run lint
          npm test -- --maxWorkers=2
          npm run build

      - name: License Compliance Check
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking license compliance..."
          npx license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD;CC0-1.0;Unlicense" --summary

      - name: Validate Lockfile
        if: github.event_name == 'pull_request'
        run: |
          echo "Validating package-lock.json..."
          npm ci --dry-run
          git diff --exit-code package-lock.json || {
            echo "ERROR: package-lock.json is out of sync with package.json"
            echo "Run 'npm install' locally and commit the updated lockfile"
            exit 1
          }

      - name: Create Security Issue
        if: failure() && steps.audit.outcome == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Security Vulnerabilities Detected',
              labels: ['security', 'dependencies', 'priority-high'],
              body: `##Security Scan Failed

              Critical or high severity vulnerabilities were detected.

              **Action Required:** Review and patch immediately.

              Run locally:
              \`\`\`bash
              npm audit
              \`\`\`

              [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
              `
            })
